// æ·»åŠ åœ¨ main.cpp çš„ loop() å‡½æ•°ä¸­ï¼Œåœ¨çº¢å¤–å­¦ä¹ æ£€æŸ¥ä¹‹åæ·»åŠ ï¼š

// ä¸²å£å‘½ä»¤å¤„ç†ï¼ˆYS-IRTMé€‚é…ç‰ˆï¼‰
if (Serial.available()) {
  String cmd = Serial.readStringUntil('\n');
  cmd.trim();
  cmd.toUpperCase();  // è½¬æ¢ä¸ºå¤§å†™ï¼Œæ–¹ä¾¿è¾“å…¥

  Serial.println("ğŸ“¨ æ”¶åˆ°å‘½ä»¤: " + cmd);

  // çº¢å¤–å­¦ä¹ æ¨¡å¼
  if (cmd == "LEARN" || cmd == "LEARN_MODE") {
    if (codeCount >= 16) {
      Serial.println("âš ï¸ å·²å­¦ä¹ æ»¡16ä¸ªæŒ‰é”®ï¼Œè¯·å…ˆæ¸…é™¤å­¦ä¹ æ•°æ®");
      return;
    }

    irLearnMode = true;
    lastIrLearnTime = millis();
    displayIRLearnMode();
    Serial.println("ğŸ“ è¿›å…¥çº¢å¤–å­¦ä¹ æ¨¡å¼");
    Serial.println("   å¯¹å‡†YS-IRTMæ¨¡å—æŒ‰ä¸‹é¥æ§å™¨æŒ‰é”®");
    Serial.println("   æŒ‰é”®å­¦ä¹ é¡ºåºï¼š");
    Serial.println("   1. ç”µæº  2. æ¸©åº¦+  3. æ¸©åº¦-  4. æ¨¡å¼");
    Serial.println("   5. é£é€Ÿ  6. æ‘†é£   7. å¼ºåŠ›   8. ç¡çœ ");
    Serial.println("   30ç§’æ— æ“ä½œè‡ªåŠ¨é€€å‡º");
  }

  // æ¸…é™¤å­¦ä¹ æ•°æ®
  else if (cmd == "CLEAR_LEARN" || cmd == "CLEAR") {
    codeCount = 0;
    for (int i = 0; i < 16; i++) {
      learnedCodes[i] = "";
      codeNames[i] = "";
    }
    Serial.println("âœ… å­¦ä¹ æ•°æ®å·²æ¸…é™¤");
    displayACStatus();
  }

  // å‘é€å­¦ä¹ çš„çº¢å¤–ä»£ç 
  else if (cmd.startsWith("SEND_")) {
    int index = cmd.substring(5).toInt() - 1;  // SEND_1 -> index 0
    if (index >= 0 && index < codeCount) {
      sendHaierACCommand(index);
    } else {
      Serial.println("âŒ æ— æ•ˆçš„ä»£ç ç´¢å¼• (1-" + String(codeCount) + ")");
    }
  }

  // ç”µæºæ§åˆ¶ï¼ˆå‘é€ç´¢å¼•1ï¼šç”µæºï¼‰
  else if (cmd == "AC_POWER_ON" || cmd == "AC_ON" || cmd == "ON") {
    if (codeCount >= 1) {
      sendHaierACCommand(0);  // ç´¢å¼•0æ˜¯ç”µæºé”®
      Serial.println("âœ… ç©ºè°ƒç”µæºå¼€å…³");
    } else {
      Serial.println("âŒ è¯·å…ˆå­¦ä¹ ç”µæºé”®");
    }
  }

  // æ¸©åº¦æ§åˆ¶ï¼ˆå‘é€ç´¢å¼•2å’Œ3ï¼‰
  else if (cmd.startsWith("AC_TEMP_") || cmd.startsWith("TEMP_")) {
    String tempStr = cmd.substring(cmd.lastIndexOf('_') + 1);
    int temp = tempStr.toInt();

    if (temp < 16 || temp > 30) {
      Serial.println("âŒ æ¸©åº¦èŒƒå›´é”™è¯¯ (16-30Â°C)");
      return;
    }

    // å…ˆæ‰“å¼€ç©ºè°ƒ
    if (codeCount >= 1) {
      sendHaierACCommand(0);
      delay(500);
    }

    // æ ¹æ®å½“å‰æ¸©åº¦è°ƒæ•´ï¼ˆç®€å•å®ç°ï¼šå‡è®¾å½“å‰26åº¦ï¼‰
    // å®é™…åº”ç”¨ä¸­éœ€è¦ç»´æŠ¤å½“å‰æ¸©åº¦çŠ¶æ€
    int currentTemp = 26;
    int diff = temp - currentTemp;

    // å‘é€æ¸©åº¦+æˆ–æ¸©åº¦-
    for (int i = 0; i < abs(diff); i++) {
      if (diff > 0 && codeCount >= 3) {
        sendHaierACCommand(2);  // æ¸©åº¦+
      } else if (diff < 0 && codeCount >= 3) {
        sendHaierACCommand(3);  // æ¸©åº¦-
      }
      delay(300);
    }

    Serial.printf("âœ… æ¸©åº¦è®¾ç½®ä¸º %dÂ°C\n", temp);
  }

  // æ¨¡å¼æ§åˆ¶ï¼ˆå‘é€ç´¢å¼•4ï¼‰
  else if (cmd == "AC_MODE_COOL") {
    if (codeCount >= 4) {
      // å…ˆæŒ‰å‡ æ¬¡æ¨¡å¼é”®åˆ‡æ¢åˆ°åˆ¶å†·ï¼ˆéœ€è¦æ ¹æ®å®é™…æµ‹è¯•è°ƒæ•´æ¬¡æ•°ï¼‰
      for (int i = 0; i < 3; i++) {  // å‡è®¾éœ€è¦æŒ‰3æ¬¡
        sendHaierACCommand(3);
        delay(500);
      }
      Serial.println("âœ… æ¨¡å¼: åˆ¶å†·");
    } else {
      Serial.println("âŒ è¯·å…ˆå­¦ä¹ æ¨¡å¼é”®");
    }
  }
  else if (cmd == "AC_MODE_HEAT") {
    if (codeCount >= 4) {
      for (int i = 0; i < 2; i++) {
        sendHaierACCommand(3);
        delay(500);
      }
      Serial.println("âœ… æ¨¡å¼: åˆ¶çƒ­");
    }
  }

  // é£é€Ÿæ§åˆ¶ï¼ˆå‘é€ç´¢å¼•5ï¼‰
  else if (cmd == "AC_FAN_HIGH") {
    if (codeCount >= 5) {
      sendHaierACCommand(4);
      Serial.println("âœ… é£é€Ÿ: é«˜");
    }
  }
  else if (cmd == "AC_FAN_LOW") {
    if (codeCount >= 5) {
      sendHaierACCommand(4);
      delay(500);
      sendHaierACCommand(4);
      Serial.println("âœ… é£é€Ÿ: ä½");
    }
  }

  // å…¶ä»–åŠŸèƒ½
  else if (cmd == "AC_SWING_ON") {
    if (codeCount >= 6) {
      sendHaierACCommand(5);
      Serial.println("âœ… æ‘†é£: å¼€å¯");
    }
  }
  else if (cmd == "AC_TURBO_ON") {
    if (codeCount >= 7) {
      sendHaierACCommand(6);
      Serial.println("âœ… å¼ºåŠ›: å¼€å¯");
    }
  }
  else if (cmd == "AC_SLEEP_ON") {
    if (codeCount >= 8) {
      sendHaierACCommand(7);
      Serial.println("âœ… ç¡çœ : å¼€å¯");
    }
  }

  // çŠ¶æ€æŸ¥è¯¢
  else if (cmd == "AC_STATUS" || cmd == "STATUS") {
    Serial.println("\n========== ç©ºè°ƒçŠ¶æ€ ==========");
    Serial.printf("å·²å­¦ä¹ æŒ‰é”®æ•°: %d/16\n", codeCount);
    Serial.println("\nå­¦ä¹ æŒ‰é”®åˆ—è¡¨:");
    for (int i = 0; i < codeCount; i++) {
      Serial.printf("  %d. %s - %s\n", i+1, codeNames[i].c_str(), learnedCodes[i].c_str());
    }
    Serial.println("==============================\n");
  }

  // YS-IRTMæ¨¡å—æµ‹è¯•
  else if (cmd == "TEST_IR") {
    Serial.println("ğŸ§ª æµ‹è¯•YS-IRTMæ¨¡å—...");

    // æŸ¥è¯¢æ¨¡å—ç‰ˆæœ¬
    sendYSIRTMCommand("AT+VERSION");
    delay(100);
    String response;
    if (receiveYSIRTMData(response, 1000)) {
      Serial.println("æ¨¡å—ç‰ˆæœ¬: " + response);
    }

    // æŸ¥è¯¢æ¨¡å—æ¨¡å¼
    sendYSIRTMCommand("AT+SENDMODE?");
    delay(100);
    if (receiveYSIRTMData(response, 1000)) {
      Serial.println("å‘é€æ¨¡å¼: " + response);
    }
  }

  // å‘é€è‡ªå®šä¹‰çº¢å¤–ä»£ç 
  else if (cmd.startsWith("SEND_CODE:")) {
    String code = cmd.substring(10);
    if (code.length() == 16) {  // YS-IRTMä»£ç æ˜¯16ä½åå…­è¿›åˆ¶
      sendIRCode(code);
    } else {
      Serial.println("âŒ ä»£ç æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º16ä½åå…­è¿›åˆ¶");
    }
  }

  // å¸®åŠ©
  else if (cmd == "HELP" || cmd == "?") {
    Serial.println("\n========== å¯ç”¨å‘½ä»¤ ==========");
    Serial.println("å­¦ä¹ ç›¸å…³:");
    Serial.println("  LEARN / LEARN_MODE  - è¿›å…¥çº¢å¤–å­¦ä¹ æ¨¡å¼");
    Serial.println("  CLEAR_LEARN / CLEAR - æ¸…é™¤å­¦ä¹ æ•°æ®");
    Serial.println("  SEND_1 ~ SEND_16    - å‘é€å­¦ä¹ æŒ‰é”®1-16");
    Serial.println("  STATUS              - æŸ¥çœ‹å­¦ä¹ çŠ¶æ€");
    Serial.println("ç©ºè°ƒæ§åˆ¶:");
    Serial.println("  AC_ON / ON          - ç”µæºå¼€å…³");
    Serial.println("  TEMP_26             - è®¾ç½®æ¸©åº¦26Â°C (16-30)");
    Serial.println("  AC_MODE_COOL        - åˆ¶å†·æ¨¡å¼");
    Serial.println("  AC_MODE_HEAT        - åˆ¶çƒ­æ¨¡å¼");
    Serial.println("  AC_FAN_HIGH         - é«˜é£é€Ÿ");
    Serial.println("  AC_FAN_LOW          - ä½é£é€Ÿ");
    Serial.println("  AC_SWING_ON         - å¼€å¯æ‘†é£");
    Serial.println("  AC_TURBO_ON         - å¼€å¯å¼ºåŠ›");
    Serial.println("  AC_SLEEP_ON         - å¼€å¯ç¡çœ ");
    Serial.println("æ¨¡å—æµ‹è¯•:");
    Serial.println("  TEST_IR             - æµ‹è¯•YS-IRTMæ¨¡å—");
    Serial.println("  SEND_CODE:XXXXXXXX  - å‘é€è‡ªå®šä¹‰çº¢å¤–ä»£ç ");
    Serial.println("  HELP / ?            - æ˜¾ç¤ºå¸®åŠ©");
    Serial.println("==============================\n");
  }

  else if (cmd != "") {
    Serial.println("âŒ æœªçŸ¥å‘½ä»¤ï¼Œè¾“å…¥ HELP æŸ¥çœ‹å¯ç”¨å‘½ä»¤");
  }
}

// æ·»åŠ å¯åŠ¨ä¿¡æ¯æ‰“å°å‡½æ•°
void printStartupInfo() {
  Serial.println("\n========================================");
  Serial.println("ğŸ  ESP32 + YS-IRTM ç©ºè°ƒæ§åˆ¶ç³»ç»Ÿ");
  Serial.println("========================================");
  Serial.println("ğŸ“¡ YS-IRTMçº¢å¤–æ¨¡å—:");
  Serial.println("   UART: GPIO16(RX) / GPIO17(TX)");
  Serial.println("   æ³¢ç‰¹ç‡: 115200");
  Serial.println("   åè®®: NECç¼–ç ");
  Serial.println("ğŸ“ çº¢å¤–å­¦ä¹ :");
  Serial.println("   1. ä¸²å£è¾“å…¥ LEARN è¿›å…¥å­¦ä¹ æ¨¡å¼");
  Serial.println("   2. å¯¹å‡†æ¨¡å—æŒ‰ä¸‹é¥æ§å™¨æŒ‰é”®");
  Serial.println("   3. 30ç§’è¶…æ—¶è‡ªåŠ¨é€€å‡º");
  Serial.println("ğŸ’¡ ç©ºè°ƒæ§åˆ¶:");
  Serial.println("   ä¸²å£è¾“å…¥ HELP æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤");
  Serial.println("========================================\n");
}

// åœ¨ setup() å‡½æ•°æœ€åè°ƒç”¨:
// printStartupInfo();
