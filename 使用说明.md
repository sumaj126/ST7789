# ESP32 温湿度显示系统 - 使用说明

## 📦 硬件清单

| 硬件 | 数量 | 说明 |
|------|------|------|
| ESP32开发板 | 1 | 主控板 |
| ST7789 TFT屏幕 (240x240) | 1 | 显示屏 |
| DHT22温湿度传感器 | 1 | 温湿度检测（比DHT11更精确） |
| 杜邦线 | 若干 | 连接线 |
| 面包板 | 1 | (可选) |

## 🔌 硬件连接

### ST7789 TFT屏幕
```
ST7789    ESP32
──────────────────
VCC   -> 3.3V
GND   -> GND
SCL   -> GPIO18
SDA   -> GPIO23
RES   -> GPIO15 (可选)
DC    -> GPIO2
CS    -> GPIO5 (可选，可接地)
BLK   -> 5V (必需！)
```

### DHT22传感器
```
DHT22 -> ESP32
──────────────────
VCC  -> 3.3V
GND  -> GND
DATA -> GPIO14
```

**注意**：建议在DHT22的VCC和DATA之间加一个10K上拉电阻。

## 💻 软件安装

### 1. 准备开发环境
- 安装 PlatformIO
- 克隆/下载本项目
- 在 PlatformIO 中打开项目

### 2. 编译上传
```bash
# 在项目目录执行
pio run --target upload
```

### 3. 打开串口监视器
- 波特率: 115200
- 选择正确的COM端口

## 📺 屏幕显示

系统启动后，屏幕会显示：

```
┌──────────────────────────┐
│  2025-01-27              │  ← 日期
│  周二                    │
├──────────────────────────┤
│     14:30:25             │  ← 时间（秒数跳动）
├──────────────────────────┤
│  温度    湿度            │
│  26.5°C  65.2%           │  ← 温湿度
└──────────────────────────┘
```

## 🎯 功能说明

### 1. 时间显示
- 自动从NTP服务器同步网络时间
- 时区设置为 UTC+8（北京时间）
- 每分钟自动同步一次

### 2. 温湿度显示
- 使用DHT22传感器
- 温度范围：-40°C ~ 80°C
- 湿度范围：0% ~ 100%
- 每5秒更新一次
- 颜色动态变化：
  - 温度 < 20°C：蓝色
  - 温度 20-30°C：黄色
  - 温度 > 30°C：红色

### 3. WiFi连接
- 自动连接配置的WiFi
- 断线自动重连
- 信号强度显示

### 4. 数据上传
- 每60秒上传温湿度数据到云服务器
- JSON格式：`{"temperature":26.5,"humidity":65.2}`
- 每60秒上报定时空调状态到服务器（MQTT）
- JSON格式：`{"enabled":true}`
- 上传地址：`http://175.178.158.54:7789/update`
- MQTT Broker：`175.178.158.54:1883`

### 5. 空调远程控制（办公室版本）
- **手动控制**：通过Web页面手动开关空调
- **定时控制**：工作日8:00-17:30，温度低于17°C自动开启
- **MQTT协议**：使用MQTT消息控制空调红外指令
- **状态确认**：ESP32接收指令后返回确认状态

### 6. 看门狗保护
- 8秒超时自动复位
- 防止系统死机
- MQTT任务每5秒喂狗

## ⚙️ 配置说明

### WiFi配置
在 `main.cpp` 中修改：
```cpp
const char* ssid = "你的WiFi名称";
const char* password = "你的WiFi密码";
```

### 云服务器配置
```cpp
const char* serverUrl = "http://175.178.158.54:7789/update";
const unsigned long uploadInterval = 60000;  // 上传间隔(毫秒)，60秒
```

### MQTT配置（空调控制）
```cpp
const char* mqttServer = "175.178.158.54";
const int mqttPort = 1883;
const char* mqttTopic = "office/ac/control";           // 手动空调控制
const char* mqttScheduleTopic = "office/ac/schedule/enabled";  // 定时空调开关
const char* mqttStatusTopic = "office/ac/schedule/status";    // 状态确认
```

### 传感器引脚
```cpp
#define DHTPIN 14      // DHT22数据引脚
#define DHTTYPE DHT22  // 传感器类型
```

## 🔧 DHT22 vs DHT11 对比

| 特性 | DHT22 | DHT11 |
|------|-------|-------|
| 温度范围 | -40°C ~ 80°C | 0°C ~ 50°C |
| 温度精度 | ±0.5°C | ±2°C |
| 湿度范围 | 0% ~ 100% | 20% ~ 90% |
| 湿度精度 | ±2% | ±5% |
| 采样频率 | 0.5Hz (2秒一次) | 1Hz (1秒一次) |
| 工作电压 | 3.3V-5V | 3.3V-5V |

**DHT22的优势**：更宽的测量范围、更高的精度

## 📊 串口输出示例

启动时会看到：
```
========================================
🚀 系统启动 #1
重启原因: 上电复位
========================================

⏱️  启用看门狗 (超时时间: 8秒)
📡 连接WiFi: jiajia
.....
✅ WiFi连接成功! IP: 192.168.1.100
📶 信号强度: -45 dBm

🌡️  DHT22传感器已初始化
📺 ST7789屏幕已初始化
🕒 NTP客户端已启动
⏰ 正在同步网络时间... ✅ 成功!
当前时间: 14:30:25

✅ 系统初始化完成！
========================================
```

运行时会看到：
```
Temp: 26.5 C, Humi: 65.2 %
📤 上传数据到云服务器: {"temperature":26.5,"humidity":65.2}
✅ 上传成功! 响应码: 200
```

## 🛠️ 故障排除

### 1. 屏幕不亮
```
检查：
✓ BLK引脚是否接5V
✓ VCC引脚是否接3.3V
✓ GND是否正确连接
```

### 2. 屏幕花屏
```
检查：
✓ SCL和SDA是否接对
✓ SPI接线是否松动
✓ 电压是否稳定
```

### 3. 温湿度显示错误
```
检查：
✓ DHT22 DATA引脚是否接GPIO14
✓ 是否有上拉电阻
✓ 传感器是否损坏
```

### 4. WiFi连接失败
```
检查：
✓ WiFi名称和密码是否正确
✓ WiFi信号是否足够强
✓ 路由器是否正常运行
```

### 5. 时间不准确
```
检查：
✓ 网络连接是否正常
✓ NTP服务器是否可达
✓ 防火墙是否阻止UDP端口123
```

### 6. MQTT空调控制无响应
```
检查：
✓ MQTT服务器地址和端口是否正确
✓ MQTT服务是否正常运行
✓ 红外模块是否正确连接
✓ 串口监视器是否显示MQTT消息接收
✓ 是否能看到"定期上报定时空调状态"日志
```

## 📖 代码结构

```
main.cpp
├── 1. 基础配置
│   ├── WiFi配置
│   ├── 云服务器配置
│   ├── MQTT配置
│   └── 传感器配置
├── 2. 函数前置声明
├── 3. 核心工具函数
│   ├── feedWatchdog()
│   ├── uploadDataToServer()
│   ├── checkAndReconnectWiFi()
│   └── initIRModule()
├── 4. 界面绘制
│   ├── drawBeautifulBorder()
│   └── initTempHumiUI()
├── 5. 时钟更新
│   └── updateClock()
├── 6. 温湿度更新
│   └── updateTempHumi()
├── 7. MQTT控制
│   ├── mqttCallback()
│   └── mqttTask()
└── 8. 初始化/主循环
    ├── setup()
    └── loop()
```

## 🌐 Web监控页面

### 办公室温度监控页面
- **访问地址**：`http://175.178.158.54:7789/`
- **功能**：
  - 实时显示温湿度（每10秒自动刷新）
  - 在线/离线状态显示（90秒无数据显示离线）
  - 手动空调控制按钮（开/关）
  - 定时空调开关（工作日8:00-17:30，温度<17°C自动开）
  - ESP32状态确认反馈

### 服务器架构
详细架构说明请查看：`服务器架构说明.md`

## 💡 使用提示

1. **首次使用**：等待WiFi连接和时间同步完成（约30秒）
2. **断线重连**：系统会自动重连WiFi，无需手动干预
3. **数据上传**：确保云服务器正常运行
4. **看门狗**：如果系统卡住超过8秒会自动重启
5. **传感器精度**：DHT22首次读取可能不准确，多次采样后稳定

## 📞 技术支持

- 查看串口输出调试信息
- 检查硬件接线
- 验证网络连接
- 测试传感器功能

## 📄 相关文档

- `硬件接线说明.txt` - 详细接线说明
- `platformio.ini` - 项目配置文件
- `main.cpp` - 主程序代码

---

**祝您使用愉快！** 🎉
