# ESP32 红外空调控制系统使用说明

## 硬件连接

### 1. 红外接收模块 (VS1838B)
```
VS1838B 红外接收器：
├─────┬─────┬─────┐
│ VCC │ OUT │ GND │
└─────┴─────┴─────┘
  ↓     ↓     ↓
3.3V  GPIO19 GND
```

### 2. 红外发射模块
```
方案A：使用红外LED + NPN三极管驱动
5V ──┬── 红外LED(+) ───┐
     │                │
     │               NPN(2N2222/8050)
     │                │     │
    GND               GND   GPIO18
                      (通过220Ω电阻)

方案B：使用红外发射二极管模块
VCC → 5V
GND → GND
IN  → GPIO18
```

### 引脚分配总结
| 功能 | 引脚 | 说明 |
|------|------|------|
| TFT CS | GPIO5 | ST7789 片选 |
| TFT DC | GPIO2 | ST7789 数据/命令 |
| TFT RST | GPIO15 | ST7789 复位 |
| DHT11 | GPIO14 | 温湿度传感器 |
| IR RX | GPIO19 | 红外接收 |
| IR TX | GPIO18 | 红外发射 |

## 功能说明

### 1. 红外学习功能
系统能够学习海尔空调遥控器的按键，支持最多16个按键。

**学习步骤：**
1. 修改代码，在setup()中添加：
   ```cpp
   irLearnMode = true;  // 启动时进入学习模式
   lastIrLearnTime = millis();
   ```
   或者通过串口命令进入学习模式

2. 按顺序对准红外接收器按下遥控器按键：
   - 电源
   - 温度+
   - 温度-
   - 模式
   - 风速
   - 摆风
   - 强力
   - 睡眠

3. 每个按键代码会被存储在数组中，可在串口监视器查看

4. 30秒无操作自动退出学习模式

### 2. 空调控制
通过红外发射模块发送学习到的按键代码控制空调。

**控制方法：**

**方法1：串口命令**
在串口监视器中输入命令：
```
AC_POWER_ON    # 开启空调
AC_POWER_OFF   # 关闭空调
AC_TEMP_26     # 设置温度26度
AC_MODE_COOL   # 制冷模式
AC_MODE_HEAT   # 制热模式
AC_FAN_HIGH    # 高风速
```

**方法2：程序控制**
修改代码中的 `acState` 结构体后调用：
```cpp
acState.power = true;
acState.temp = 26;
acState.mode = 1;  // 制冷
sendHaierACCommand(acState);
```

### 3. 屏幕显示
- 顶部：日期和星期
- 中间：时间显示
- 左下：温度
- 右下：湿度
- 最上方：空调状态条

## 代码扩展

### 添加串口命令控制
在主循环中添加：
```cpp
if (Serial.available()) {
  String cmd = Serial.readStringUntil('\n');
  cmd.trim();

  if (cmd == "AC_POWER_ON") {
    acState.power = true;
    sendHaierACCommand(acState);
  }
  else if (cmd == "AC_POWER_OFF") {
    acState.power = false;
    sendHaierACCommand(acState);
  }
  // ... 更多命令
}
```

### 添加WiFi Web控制
使用ESP32 WebServer创建简单的控制界面，通过手机浏览器控制空调。

### 添加自动控制逻辑
根据温湿度自动调节空调：
```cpp
if (temperature > 28 && !acState.power) {
  acState.power = true;
  acState.temp = 26;
  acState.mode = 1;  // 制冷
  sendHaierACCommand(acState);
}
```

## 常见问题

### Q1: 红外学习不成功
**A:**
- 确保红外接收器正确连接
- 遥控器对准接收器距离5-10cm
- 检查串口输出，确认接收到信号
- 部分遥控器使用38kHz载波，部分使用56kHz，需要调整代码

### Q2: 发射无法控制空调
**A:**
- 确保红外LED与空调接收器对准（通常在空调右侧面板）
- 距离建议3-5米内
- 检查三极管驱动电路是否正确
- 尝试调整发射次数：`irsend.sendNEC(code, 32, 3);` (发送3次)

### Q3: 海尔空调特殊协议
**A:**
部分海尔空调使用专有协议，不是标准的NEC协议。可以使用IRremoteESP8266库的`IRHaierAC`类：
```cpp
#include <ir_Haier.h>
IRHaierAC ac(IR_SEND_PIN);
ac.begin();
ac.on();
ac.setTemp(26);
ac.setMode(kHaierAcCool);
ac.setFan(kHaierAcFanHigh);
ac.send();
```

### Q4: 学习代码不完整
**A:**
- 部分遥控器发送完整命令需要多次按键（如温度从26调到27需要按3次）
- 可以记录完整的按键序列
- 使用逻辑分析仪分析红外信号时序

## 升级建议

1. **添加Web界面**：通过WiFi创建Web控制界面
2. **手机App**：使用MQTT协议实现手机远程控制
3. **语音控制**：接入小爱同学或天猫精灵
4. **定时任务**：设置定时开关机
5. **场景模式**：根据时间段自动调节（如工作时间制冷）
6. **多空调控制**：支持控制多台空调

## 安全注意事项

1. 红外发射时不要直视眼睛
2. 使用5V供电红外LED时注意限流电阻
3. 三极管驱动电路注意极性
4. 学习模式时避免其他红外干扰（如电视遥控器）

## 技术支持

- IRremoteESP8266库文档: https://github.com/crankyoldgit/IRremoteESP8266
- 海尔红外协议: 搜索 "Haier AC IR protocol"
- ESP32开发文档: https://docs.espressif.com/projects/arduino-esp32/
