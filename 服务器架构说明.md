# è…¾è®¯äº‘æœåŠ¡å™¨æ¶æ„æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†éƒ¨ç½²åœ¨è…¾è®¯äº‘æœåŠ¡å™¨ (175.178.158.54) ä¸Šçš„WebæœåŠ¡æ¶æ„ï¼Œä¸»è¦ç”¨äºå®¶åº­/åŠå…¬å®¤ç›‘æ§ã€ç©ºè°ƒè¿œç¨‹æ§åˆ¶å’Œç…§ç‰‡ç®¡ç†ç³»ç»Ÿã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è…¾è®¯äº‘æœåŠ¡å™¨ (175.178.158.54)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                     â”‚                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      ç«¯å£ 80 (HTTP)     â”‚              â”‚     ç«¯å£ 22 (SSH)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       Nginx (åå‘ä»£ç†)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚                â”‚              â”‚
â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”
â”‚ 7788ç«¯å£ â”‚    â”‚ 7789ç«¯å£ â”‚   â”‚ 7791ç«¯å£â”‚  â”‚  æ ¹è·¯å¾„  â”‚
â”‚(ç¾¤æ™–ESP32)â”‚  â”‚(åŠå…¬å®¤ESP32)â”‚ â”‚(PCæˆ¿é—´ESP32)â”‚  â”‚ (ç…§ç‰‡ç«™) â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚               â”‚              â”‚
å¤–éƒ¨ä»£ç†       Node.js        Node.js        PHP-FPM
sumaj.synology.me:7788  ç«¯å£3789     ç«¯å£3791       ç«¯å£9000
                     â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    MQTT 1883     â”‚
            â”‚   (ç©ºè°ƒè¿œç¨‹æ§åˆ¶)  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æœåŠ¡æ¸…å•

### 1. Nginx WebæœåŠ¡å™¨
**ç«¯å£**: 80, 7788, 7789, 7791

**åŠŸèƒ½**:
- åå‘ä»£ç†
- é™æ€æ–‡ä»¶æœåŠ¡
- SSLæ”¯æŒ
- è´Ÿè½½å‡è¡¡

**é…ç½®æ–‡ä»¶ä½ç½®**:
- ä¸»é…ç½®: `/etc/nginx/nginx.conf`
- ç«™ç‚¹é…ç½®: `/etc/nginx/sites-available/`
- å¯ç”¨ç«™ç‚¹: `/etc/nginx/sites-enabled/`

**ç«™ç‚¹é…ç½®**:
| é…ç½®æ–‡ä»¶ | å¤–éƒ¨ç«¯å£ | åç«¯æœåŠ¡ | è¯´æ˜ |
|----------|---------|----------|------|
| esp32 | 7788 | sumaj.synology.me:7788 | ç¾¤æ™–ESP32ä»£ç† |
| esp32-office | 7789 | 127.0.0.1:3789 | åŠå…¬å®¤ESP32 |
| pcroom-receiver | 7791 | 127.0.0.1:3791 | PCæˆ¿é—´ESP32 |
| default | 80 | PHP-FPM:9000 | ç…§ç‰‡ç®¡ç†ç³»ç»Ÿ |

### 2. PHP-FPM (PHP FastCGI Process Manager)
**ç«¯å£**: 9000 (Unix Socket: `/var/run/php/php8.3-fpm.sock`)

**åŠŸèƒ½**:
- å¤„ç†PHPè¯·æ±‚
- ç…§ç‰‡ä¸Šä¼ API
- æ•°æ®åº“æ“ä½œ

**é…ç½®æ–‡ä»¶**: `/etc/php/8.3/fpm/`

### 3. MySQL æ•°æ®åº“
**ç«¯å£**: 3306

**æ•°æ®åº“**: `photo_gallery`

**åŠŸèƒ½**:
- å­˜å‚¨ç…§ç‰‡å…ƒæ•°æ®
- ç®¡ç†ç›¸å†Œç›®å½•
- ç”¨æˆ·è®¤è¯ä¿¡æ¯

**é…ç½®æ–‡ä»¶**: `/etc/mysql/my.cnf`

### 4. Node.js åŠå…¬å®¤æ¸©åº¦ç›‘æ§æœåŠ¡
**ç«¯å£**: 3789 (å†…éƒ¨)

**åŠŸèƒ½**:
- æ¥æ”¶ESP32ä¸Šä¼ çš„æ¸©æ¹¿åº¦æ•°æ®
- æä¾›Webç›‘æ§é¡µé¢
- æ•°æ®å®æ—¶æ˜¾ç¤º (10ç§’è‡ªåŠ¨åˆ·æ–°)
- ç©ºè°ƒæ‰‹åŠ¨æ§åˆ¶ç•Œé¢
- å®šæ—¶ç©ºè°ƒå¼€å…³åŠŸèƒ½
- ESP32çŠ¶æ€ç¡®è®¤åé¦ˆ

**æœåŠ¡ä¿¡æ¯**:
- å·¥ä½œç›®å½•: `/opt/esp32-receiver/`
- ä¸»ç¨‹åº: `server.js`
- SystemdæœåŠ¡: `esp32-office.service`

### 5. Node.js PCæˆ¿é—´æ¸©åº¦ç›‘æ§æœåŠ¡
**ç«¯å£**: 3791 (å†…éƒ¨)

**åŠŸèƒ½**:
- æ¥æ”¶ESP32ä¸Šä¼ çš„æ¸©æ¹¿åº¦æ•°æ®
- æä¾›Webç›‘æ§é¡µé¢

**æœåŠ¡ä¿¡æ¯**:
- å·¥ä½œç›®å½•: `/opt/pcroom-receiver/`
- ä¸»ç¨‹åº: `server.js`
- SystemdæœåŠ¡: `pcroom-receiver.service`

### 6. MQTT Broker (Mosquitto)
**ç«¯å£**: 1883

**åŠŸèƒ½**:
- æä¾›MQTTæ¶ˆæ¯ä»£ç†æœåŠ¡
- æ”¯æŒESP32è¿œç¨‹æ§åˆ¶ç©ºè°ƒ
- å®šæ—¶ç©ºè°ƒå¼€å…³çŠ¶æ€åŒæ­¥
- å…è®¸åŒ¿åè®¿é—®

**é…ç½®æ–‡ä»¶**: `/etc/mosquitto/mosquitto.conf`, `/etc/mosquitto/conf.d/custom.conf`

**æœåŠ¡ä¿¡æ¯**:
- æœåŠ¡å: `mosquitto`
- ç›‘å¬åœ°å€: `0.0.0.0:1883` (å…è®¸å¤–éƒ¨è¿æ¥)
- å…è®¸åŒ¿å: `true`

**MQTTä¸»é¢˜**:
| ä¸»é¢˜ | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| office/ac/control | æœåŠ¡å™¨ â†’ ESP32 | ç©ºè°ƒå¼€å…³æŒ‡ä»¤ |
| office/ac/schedule/enabled | æœåŠ¡å™¨ â†’ ESP32 | å®šæ—¶ç©ºè°ƒå¼€å…³çŠ¶æ€ |
| office/ac/schedule/status | ESP32 â†’ æœåŠ¡å™¨ | ESP32ç¡®è®¤çŠ¶æ€ |

---

## ğŸŒ æœåŠ¡ç«¯ç‚¹è¯¦è§£

### ğŸ“ ç«¯å£ 7788 - ç¾¤æ™–ESP32ç›‘æ§ (å¤–éƒ¨ä»£ç†)

#### åå‘ä»£ç†é…ç½®
```nginx
server {
    listen 7788;
    server_name _;
    
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'Content-Type';
    
    location / {
        proxy_pass http://sumaj.synology.me:7788;
        proxy_set_header Host sumaj.synology.me;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 300s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
}
```

**è¯´æ˜**: æ­¤ç«¯å£ä»£ç†åˆ°å¤–éƒ¨çš„Synology NASè®¾å¤‡

---

### ğŸ“ ç«¯å£ 7789 - åŠå…¬å®¤æ¸©åº¦ç›‘æ§

#### æ¶æ„
```
å¤–éƒ¨è®¿é—® (7789)
    â†“
Nginx åå‘ä»£ç†
    â†“
Node.js æœåŠ¡ (3789)
    â†“
MQTT Broker (1883)
```

#### Nginxé…ç½®
```nginx
server {
    listen 7789;
    server_name _;

    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'Content-Type';

    location / {
        proxy_pass http://127.0.0.1:3789;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 300s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
}
```

#### Node.jsæœåŠ¡ (`/opt/esp32-receiver/server.js`)

**æ¥æ”¶æ•°æ®æ¥å£**:
- URL: `http://175.178.158.54:7789/update`
- æ–¹æ³•: POST
- Content-Type: application/json
- æ•°æ®æ ¼å¼:
  ```json
  {
    "temperature": 18.0,
    "humidity": 50.0
  }
  ```

**APIæ¥å£**:
| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/data` | GET | è·å–æœ€æ–°æ¸©æ¹¿åº¦æ•°æ® |
| `/api/status` | GET | è·å–å®šæ—¶ç©ºè°ƒçŠ¶æ€ |
| `/ac` | POST | æ‰‹åŠ¨ç©ºè°ƒæ§åˆ¶ |
| `/schedule` | POST | å®šæ—¶ç©ºè°ƒå¼€å…³æ§åˆ¶ |

**ç›‘æ§é¡µé¢**:
- URL: `http://175.178.158.54:7789/`
- æ–¹æ³•: GET
- åŠŸèƒ½: æ˜¾ç¤ºå®æ—¶æ¸©æ¹¿åº¦æ•°æ®
- è‡ªåŠ¨åˆ·æ–°: 10ç§’
- åœ¨çº¿çŠ¶æ€åˆ¤æ–­: 90ç§’å†…æœ‰æ•°æ®

**åŠŸèƒ½ç‰¹æ€§**:
- å®æ—¶æ—¶é’Ÿæ˜¾ç¤º
- æ¸©æ¹¿åº¦æ•°æ®åŠ¨æ€é¢œè‰²
- æ‰‹åŠ¨ç©ºè°ƒæ§åˆ¶ï¼ˆå¼€/å…³ï¼‰
- å®šæ—¶ç©ºè°ƒå¼€å…³
- ESP32çŠ¶æ€ç¡®è®¤åé¦ˆ

---

### ğŸ“ ç«¯å£ 7791 - PCæˆ¿é—´æ¸©åº¦ç›‘æ§

#### æ¶æ„
```
å¤–éƒ¨è®¿é—® (7791)
    â†“
Nginx åå‘ä»£ç†
    â†“
Node.js æœåŠ¡ (3791)
```

#### Nginxé…ç½®
```nginx
server {
    listen 7791;
    server_name _;

    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'Content-Type';

    location / {
        proxy_pass http://127.0.0.1:3791;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 300s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
}
```

---

### ğŸ“ ç«¯å£ 80 - ä¸»ç½‘ç«™ (ç…§ç‰‡ç®¡ç†ç³»ç»Ÿ)

#### è·¯ç”±é…ç½®

| è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ | å¤„ç†æ–¹å¼ |
|------|------|------|---------|
| `/` | GET | ç…§ç‰‡å±•ç¤ºä¸»é¡µ | index.html |
| `/login` | GET | ç™»å½•é¡µé¢ | login.html |
| `/api/albums` | GET | è·å–ç›¸å†Œåˆ—è¡¨ | api.php |
| `/api/albums` | POST | åˆ›å»ºç›¸å†Œ | api.php |
| `/api/albums/{id}` | PUT | ç¼–è¾‘ç›¸å†Œ | api.php |
| `/api/albums/{id}` | DELETE | åˆ é™¤ç›¸å†Œ | api.php |
| `/api/photos` | GET | è·å–ç…§ç‰‡åˆ—è¡¨ | api.php |
| `/api/upload` | POST | ä¸Šä¼ ç…§ç‰‡ | api.php |
| `/api/photos/{id}` | DELETE | åˆ é™¤ç…§ç‰‡ | api.php |
| `/uploads/*` | GET | ç…§ç‰‡æ–‡ä»¶ | é™æ€æ–‡ä»¶ |

#### æ–‡ä»¶ç»“æ„
```
/var/www/html/
â”œâ”€â”€ index.html          # ä¸»é¡µé¢
â”œâ”€â”€ login.html          # ç™»å½•é¡µé¢
â”œâ”€â”€ api.php            # APIå¤„ç†è„šæœ¬
â”œâ”€â”€ uploads/           # ç…§ç‰‡å­˜å‚¨ç›®å½•
â””â”€â”€ .htaccess          # Apacheå…¼å®¹é…ç½®
```

#### æ•°æ®åº“è¡¨ç»“æ„

**albums è¡¨**
```sql
CREATE TABLE albums (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) NOT NULL
);
```

**photos è¡¨**
```sql
CREATE TABLE photos (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255),
  date DATE,
  image_url VARCHAR(255),
  album_id INT,
  created_at DATETIME,
  FOREIGN KEY (album_id) REFERENCES albums(id)
);
```

#### è®¤è¯æ–¹å¼
- localStorage token: `auth_token`
- ç®€å•è®¤è¯æœºåˆ¶

---

### ğŸ“ ç«¯å£ 1883 - MQTT Broker (ç©ºè°ƒè¿œç¨‹æ§åˆ¶)

#### MQTTæœåŠ¡ä¿¡æ¯
- Brokeråœ°å€: `175.178.158.54`
- ç«¯å£: `1883`
- åè®®: MQTT 3.1.1 / 3.1
- è®¤è¯: å…è®¸åŒ¿åè®¿é—®
- QoSæ”¯æŒ: 0, 1, 2

#### MQTTé…ç½®æ–‡ä»¶ (`/etc/mosquitto/conf.d/custom.conf`)
```ini
# ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
listener 1883 0.0.0.0

# å…è®¸åŒ¿åè¿æ¥
allow_anonymous true

# æ—¥å¿—è®¾ç½®
log_dest file /var/log/mosquitto/mosquitto.log
log_type all
```

#### é˜²ç«å¢™é…ç½®
```bash
# å…è®¸MQTTç«¯å£
sudo ufw allow 1883/tcp

# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
sudo ufw status
```

#### æœåŠ¡ç®¡ç†å‘½ä»¤
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start mosquitto

# åœæ­¢æœåŠ¡
sudo systemctl stop mosquitto

# é‡å¯æœåŠ¡
sudo systemctl restart mosquitto

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status mosquitto

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo journalctl -u mosquitto -f

# æŸ¥çœ‹MQTTæ—¥å¿—æ–‡ä»¶
sudo tail -f /var/log/mosquitto/mosquitto.log
```

#### MQTTä¸»é¢˜ä¸æ¶ˆæ¯æ ¼å¼

**æ§åˆ¶ä¸»é¢˜**: `office/ac/control`

**æ¶ˆæ¯æ ¼å¼ (JSON)**:
```json
{
  "action": "on"
}
```

**å®šæ—¶ç©ºè°ƒå¼€å…³ä¸»é¢˜**: `office/ac/schedule/enabled`

**æ¶ˆæ¯æ ¼å¼ (JSON)**:
```json
{
  "enabled": true
}
```

**ESP32çŠ¶æ€ç¡®è®¤ä¸»é¢˜**: `office/ac/schedule/status`

**æ¶ˆæ¯æ ¼å¼ (JSON)**:
```json
{
  "enabled": true
}
```

**æ”¯æŒçš„æ“ä½œ**:
- `{"action": "on"}` - å¼€å¯ç©ºè°ƒ
- `{"action": "off"}` - å…³é—­ç©ºè°ƒ
- `{"enabled": true}` - å¯ç”¨å®šæ—¶ç©ºè°ƒ
- `{"enabled": false}` - ç¦ç”¨å®šæ—¶ç©ºè°ƒ

#### æµ‹è¯•MQTTè¿æ¥

**ä½¿ç”¨ mosquitto_pub/mosquitto_sub (éœ€å®‰è£… mosquitto-clients)**:
```bash
# è®¢é˜…ä¸»é¢˜ï¼Œæ¥æ”¶æ¶ˆæ¯
mosquitto_sub -h 175.178.158.54 -p 1883 -t "office/ac/control"
mosquitto_sub -h 175.178.158.54 -p 1883 -t "office/ac/schedule/status"

# å‘é€å¼€æœºæŒ‡ä»¤
mosquitto_pub -h 175.178.158.54 -p 1883 -t "office/ac/control" -m '{"action":"on"}'

# å‘é€å…³æœºæŒ‡ä»¤
mosquitto_pub -h 175.178.158.54 -p 1883 -t "office/ac/control" -m '{"action":"off"}'

# å¯ç”¨å®šæ—¶ç©ºè°ƒ
mosquitto_pub -h 175.178.158.54 -p 1883 -t "office/ac/schedule/enabled" -m '{"enabled":true}'

# ç¦ç”¨å®šæ—¶ç©ºè°ƒ
mosquitto_pub -h 175.178.158.54 -p 1883 -t "office/ac/schedule/enabled" -m '{"enabled":false}'
```

**ä½¿ç”¨MQTTå®¢æˆ·ç«¯å·¥å…·**:
- MQTTX (è·¨å¹³å°æ¡Œé¢/ç§»åŠ¨ç«¯)
- MQTT Explorer (Windows/Mac/Linux)
- HiveMQ Web Client (åœ¨çº¿å·¥å…·)

---

## ğŸ”„ æ•°æ®æµç¨‹

### åŠå…¬å®¤æ¸©æ¹¿åº¦æ•°æ®ä¸Šä¼ æµç¨‹

```
ESP32 è®¾å¤‡ (åŠå…¬å®¤)
  â†“ (WiFi æ¯60ç§’)
  â†“ POST {"temperature": 18.0, "humidity": 50.0}
  â†“
Nginx (ç«¯å£7789)
  â†“ åå‘ä»£ç†
  â†“
Node.js (ç«¯å£3789)
  â†“ è§£æJSON
  â†“ å­˜å‚¨åˆ°å†…å­˜å˜é‡
  â†“
Webé¡µé¢ (GET /)
  â†“ æ¯10ç§’é€šè¿‡ /api/data è·å–æœ€æ–°æ•°æ®
  â†“ æ˜¾ç¤ºæ•°æ®
  â†“ åœ¨çº¿çŠ¶æ€åˆ¤æ–­: 90ç§’å†…æœ‰æ•°æ®
```

### MQTTç©ºè°ƒæ§åˆ¶æµç¨‹

```
Webé¡µé¢ (æ‰‹åŠ¨æ§åˆ¶)
  â†“ HTTP POST /ac
  â†“ {"action": "on"}
  â†“
Node.js
  â†“ å‘å¸ƒMQTTæ¶ˆæ¯
  â†“ office/ac/control
  â†“
Mosquitto Broker (1883)
  â†“ è·¯ç”±æ¶ˆæ¯åˆ°è®¢é˜…è€…
  â†“
ESP32 è®¾å¤‡ (FreeRTOS MQTTä»»åŠ¡)
  â†“ æ¥æ”¶JSONæ¶ˆæ¯
  â†“ è§£æ {"action":"on"/"off"}
  â†“ å‘é€çº¢å¤–æŒ‡ä»¤åˆ°ç©ºè°ƒ
  â†“ ç©ºè°ƒæ‰§è¡Œå¼€å…³
```

### å®šæ—¶ç©ºè°ƒå¼€å…³æµç¨‹

```
Webé¡µé¢ (å®šæ—¶å¼€å…³)
  â†“ HTTP POST /schedule
  â†“ {"enabled": true}
  â†“
Node.js
  â†“ å‘å¸ƒMQTTæ¶ˆæ¯
  â†“ office/ac/schedule/enabled
  â†“
Mosquitto Broker (1883)
  â†“ è·¯ç”±æ¶ˆæ¯
  â†“
ESP32 è®¾å¤‡
  â†“ æ¥æ”¶å¹¶æ›´æ–°çŠ¶æ€
  â†“ å‘å¸ƒç¡®è®¤æ¶ˆæ¯
  â†“ office/ac/schedule/status
  â†“
Node.js (MQTTè®¢é˜…)
  â†“ æ›´æ–°å†…å­˜çŠ¶æ€
  â†“ Webé¡µé¢è½®è¯¢ /api/status
  â†“ æ˜¾ç¤ºESP32ç¡®è®¤çŠ¶æ€
```

### ç…§ç‰‡ä¸Šä¼ æµç¨‹

```
ç”¨æˆ·æµè§ˆå™¨
  â†“ ç™»å½•éªŒè¯
  â†“ é€‰æ‹©ç…§ç‰‡
  â†“
Nginx (ç«¯å£80)
  â†“ è½¬å‘åˆ°PHP
  â†“
PHP-FPM (api.php)
  â†“ éªŒè¯æ–‡ä»¶
  â†“ ä¿å­˜åˆ° /var/www/html/uploads/
  â†“ æå–EXIFä¿¡æ¯
  â†“ å­˜å‚¨åˆ°MySQL
  â†“
è¿”å›æˆåŠŸå“åº”
```

---

## ğŸ”§ ç³»ç»ŸæœåŠ¡ç®¡ç†

### Nginx
```bash
# å¯åŠ¨/åœæ­¢/é‡å¯
sudo systemctl start nginx
sudo systemctl stop nginx
sudo systemctl restart nginx

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½é…ç½®
sudo nginx -s reload
```

### Node.js åŠå…¬å®¤æœåŠ¡
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start esp32-office

# åœæ­¢æœåŠ¡
sudo systemctl stop esp32-office

# é‡å¯æœåŠ¡
sudo systemctl restart esp32-office

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status esp32-office

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u esp32-office -f

# å¼€æœºè‡ªå¯
sudo systemctl enable esp32-office
```

### Node.js PCæˆ¿é—´æœåŠ¡
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start pcroom-receiver

# åœæ­¢æœåŠ¡
sudo systemctl stop pcroom-receiver

# é‡å¯æœåŠ¡
sudo systemctl restart pcroom-receiver

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status pcroom-receiver

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u pcroom-receiver -f
```

### PHP-FPM
```bash
sudo systemctl start php8.3-fpm
sudo systemctl stop php8.3-fpm
sudo systemctl restart php8.3-fpm
```

### MySQL
```bash
sudo systemctl start mysql
sudo systemctl stop mysql
sudo systemctl restart mysql
```

### Mosquitto
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start mosquitto

# åœæ­¢æœåŠ¡
sudo systemctl stop mosquitto

# é‡å¯æœåŠ¡
sudo systemctl restart mosquitto

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status mosquitto

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo journalctl -u mosquitto -f
```

---

## ğŸ” å®‰å…¨é…ç½®

### é˜²ç«å¢™ (UFW)
```bash
# æŸ¥çœ‹çŠ¶æ€
sudo ufw status

# å…è®¸ç«¯å£
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS
sudo ufw allow 7788/tcp # ç¾¤æ™–ESP32
sudo ufw allow 7789/tcp # åŠå…¬å®¤ESP32
sudo ufw allow 7791/tcp # PCæˆ¿é—´ESP32
sudo ufw allow 1883/tcp # MQTT (ç©ºè°ƒæ§åˆ¶)
```

### æ•°æ®åº“å®‰å…¨
- æ•°æ®åº“ç”¨æˆ·: `photo_user`
- æ•°æ®åº“å¯†ç : `PhotoSecurePass123!`
- ä»…å…è®¸æœ¬åœ°è¿æ¥: `localhost`

### æ–‡ä»¶æƒé™
```bash
/var/www/html/ - 755 (ubuntu:ubuntu)
/var/www/html/uploads/ - 755 (www-data:www-data)
/opt/esp32-receiver/ - 755 (root:root)
/opt/pcroom-receiver/ - 755 (root:root)
```

---

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—æ–‡ä»¶ä½ç½®

| æœåŠ¡ | æ—¥å¿—è·¯å¾„ | è¯´æ˜ |
|------|---------|------|
| Nginx | `/var/log/nginx/access.log` | è®¿é—®æ—¥å¿— |
| Nginx | `/var/log/nginx/error.log` | é”™è¯¯æ—¥å¿— |
| PHP-FPM | `/var/log/php8.3-fpm.log` | PHPæ—¥å¿— |
| MySQL | `/var/log/mysql/error.log` | MySQLæ—¥å¿— |
| Node.js (åŠå…¬å®¤) | `journalctl -u esp32-office` | æ¸©åº¦ç›‘æ§æ—¥å¿— |
| Node.js (PCæˆ¿é—´) | `journalctl -u pcroom-receiver` | æ¸©åº¦ç›‘æ§æ—¥å¿— |
| Mosquitto | `/var/log/mosquitto/mosquitto.log` | MQTTæ—¥å¿— |
| Mosquitto | `journalctl -u mosquitto` | MQTTç³»ç»Ÿæ—¥å¿— |

### æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
# Nginxè®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log

# Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# åŠå…¬å®¤Node.jsæœåŠ¡æ—¥å¿—
sudo journalctl -u esp32-office -f

# PCæˆ¿é—´Node.jsæœåŠ¡æ—¥å¿—
sudo journalctl -u pcroom-receiver -f

# Mosquitto MQTTæ—¥å¿—
sudo journalctl -u mosquitto -f
```

---

## ğŸš€ éƒ¨ç½²ESP32è®¾å¤‡

### åŠå…¬å®¤ESP32ä»£ç é…ç½®

**WiFié…ç½®**:
```cpp
const char* ssid = "æ‚¨çš„WiFiåç§°";
const char* password = "æ‚¨çš„WiFiå¯†ç ";
```

**æœåŠ¡å™¨é…ç½®**:
```cpp
const char* serverUrl = "http://175.178.158.54:7789/update";
const unsigned long uploadInterval = 60000;  // 60ç§’ä¸Šä¼ ä¸€æ¬¡
```

**MQTTé…ç½®**:
```cpp
const char* mqttServer = "175.178.158.54";
const int mqttPort = 1883;
const char* mqttTopic = "office/ac/control";
const char* mqttScheduleTopic = "office/ac/schedule/enabled";
const char* mqttStatusTopic = "office/ac/schedule/status";
```

**ä¸Šä¼ æ•°æ®æ ¼å¼**:
```json
{
  "temperature": 18.0,
  "humidity": 50.0
}
```

**MQTTæ¶ˆæ¯æ ¼å¼**:
```json
{
  "action": "on"   // æˆ– "off"
}
```

### ESP32ç¡¬ä»¶è¿æ¥

| ä¼ æ„Ÿå™¨ | å¼•è„š | è¯´æ˜ |
|--------|------|------|
| DHT22 VCC | 3.3V | ç”µæº |
| DHT22 GND | GND | åœ°çº¿ |
| DHT22 DATA | GPIO14 | æ•°æ® |
| ST7789 TFT | SPIæ¥å£ | æ˜¾ç¤ºå± |
| çº¢å¤–æ¨¡å— RX | GPIO16 | ä¸²å£æ¥æ”¶ |
| çº¢å¤–æ¨¡å— TX | GPIO17 | ä¸²å£å‘é€ |

---

## ğŸ“± å‰ç«¯è®¿é—®

### ç…§ç‰‡ç®¡ç†ç³»ç»Ÿ
- URL: `http://175.178.158.54/`
- åŠŸèƒ½: ç…§ç‰‡æµè§ˆã€ä¸Šä¼ ã€ç›¸å†Œç®¡ç†

### ç¾¤æ™–ESP32ç›‘æ§
- URL: `http://175.178.158.54:7788/`
- åŠŸèƒ½: å®æ—¶æ¸©æ¹¿åº¦æ˜¾ç¤º
- è¯´æ˜: ä»£ç†åˆ°ç¾¤æ™–NASè®¾å¤‡

### åŠå…¬å®¤æ¸©åº¦ç›‘æ§
- URL: `http://175.178.158.54:7789/`
- åŠŸèƒ½: å®æ—¶æ¸©æ¹¿åº¦æ˜¾ç¤ºã€ç©ºè°ƒæ§åˆ¶ã€å®šæ—¶å¼€å…³
- è‡ªåŠ¨åˆ·æ–°: 10ç§’
- ä¸Šä¼ é—´éš”: 60ç§’

### PCæˆ¿é—´æ¸©åº¦ç›‘æ§
- URL: `http://175.178.158.54:7791/`
- åŠŸèƒ½: å®æ—¶æ¸©æ¹¿åº¦æ˜¾ç¤º

### MQTTç©ºè°ƒæ§åˆ¶
- Brokeråœ°å€: `175.178.158.54:1883`
- æ§åˆ¶ä¸»é¢˜: `office/ac/control`
- åŠŸèƒ½: è¿œç¨‹å¼€å…³ç©ºè°ƒ
- æµ‹è¯•å·¥å…·: MQTTX, MQTT Explorer

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### 1. åŠå…¬å®¤æ¸©åº¦ç›‘æ§é¡µé¢æ˜¾ç¤º"ç¦»çº¿"
**åŸå› **: ESP32æœªä¸Šä¼ æ•°æ®è¶…è¿‡90ç§’
**è§£å†³**:
- æ£€æŸ¥ESP32æ˜¯å¦æ­£å¸¸è¿è¡Œ
- æ£€æŸ¥WiFiè¿æ¥
- æ£€æŸ¥Node.jsæœåŠ¡çŠ¶æ€: `sudo systemctl status esp32-office`
- æŸ¥çœ‹æœåŠ¡æ—¥å¿—: `sudo journalctl -u esp32-office -n 50`
- æ£€æŸ¥MQTTè¿æ¥: `sudo journalctl -u mosquitto -n 20`

### 2. ç…§ç‰‡ä¸Šä¼ å¤±è´¥
**åŸå› **: PHP-FPMæœåŠ¡å¼‚å¸¸æˆ–ç£ç›˜ç©ºé—´ä¸è¶³
**è§£å†³**:
- æ£€æŸ¥PHP-FPM: `sudo systemctl status php8.3-fpm`
- æ£€æŸ¥ç£ç›˜ç©ºé—´: `df -h`
- æ£€æŸ¥uploadsç›®å½•æƒé™: `ls -la /var/www/html/uploads/`

### 3. Nginx 502é”™è¯¯
**åŸå› **: åç«¯æœåŠ¡æœªå¯åŠ¨
**è§£å†³**:
- æ£€æŸ¥PHP-FPM: `sudo systemctl status php8.3-fpm`
- æ£€æŸ¥Node.jsåŠå…¬å®¤: `sudo systemctl status esp32-office`
- æ£€æŸ¥Node.js PCæˆ¿é—´: `sudo systemctl status pcroom-receiver`
- æ£€æŸ¥Socketæ–‡ä»¶: `ls -la /var/run/php/`

### 4. ç«¯å£æ— æ³•è®¿é—®
**åŸå› **: é˜²ç«å¢™æˆ–Nginxé…ç½®é—®é¢˜
**è§£å†³**:
```bash
# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep -E "80|7788|7789|7791|1883"

# æµ‹è¯•Nginxé…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx
```

### 5. MQTTè¿æ¥å¤±è´¥
**åŸå› **: é˜²ç«å¢™æœªå¼€æ”¾æˆ–Mosquittoé…ç½®é—®é¢˜
**è§£å†³**:
```bash
# æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦å¼€æ”¾1883ç«¯å£
sudo ufw status | grep 1883

# å¼€æ”¾MQTTç«¯å£
sudo ufw allow 1883/tcp

# æ£€æŸ¥Mosquittoé…ç½®
sudo cat /etc/mosquitto/conf.d/custom.conf

# ç¡®è®¤ç›‘å¬åœ°å€ä¸º 0.0.0.0:1883

# é‡å¯MosquittoæœåŠ¡
sudo systemctl restart mosquitto

# æŸ¥çœ‹è¿æ¥æ—¥å¿—
sudo journalctl -u mosquitto -f
```

### 6. MQTTæ¶ˆæ¯æ— æ³•æ¥æ”¶
**åŸå› **: ESP32æœªè®¢é˜…ä¸»é¢˜æˆ–ç½‘ç»œé—®é¢˜
**è§£å†³**:
```bash
# æ£€æŸ¥ESP32 MQTTè¿æ¥çŠ¶æ€
# é€šè¿‡ESP32ä¸²å£ç›‘è§†å™¨æŸ¥çœ‹è¾“å‡º

# æ£€æŸ¥ESP32æ˜¯å¦è®¢é˜…äº†æ­£ç¡®ä¸»é¢˜
# åº”è¯¥çœ‹åˆ°: "è®¢é˜…ä¸»é¢˜: office/ac/control"

# æµ‹è¯•MQTTå‘å¸ƒæ¶ˆæ¯
mosquitto_pub -h 175.178.158.54 -p 1883 -t "office/ac/control" -m '{"action":"on"}'

# æŸ¥çœ‹Mosquittoæ—¥å¿—ç¡®è®¤æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾
sudo tail -f /var/log/mosquitto/mosquitto.log
```

### 7. ESP32çœ‹é—¨ç‹—é‡å¯
**åŸå› **: ä»»åŠ¡é˜»å¡æ—¶é—´è¿‡é•¿
**è§£å†³**:
- æ£€æŸ¥ä¸²å£ç›‘è§†å™¨è¾“å‡º
- ç¡®è®¤æ˜¯å¦æ˜¯ "task_wdt" è§¦å‘
- æ£€æŸ¥MQTTä»»åŠ¡å»¶æ—¶è®¾ç½® (å»ºè®®5ç§’)
- æ£€æŸ¥HTTPè¯·æ±‚è¶…æ—¶è®¾ç½® (å»ºè®®5ç§’)
- æŸ¥çœ‹ä»£ç ä¸­æ˜¯å¦æœ‰é•¿æ—¶é—´é˜»å¡æ“ä½œ

---

## ğŸ“ å¤‡ä»½ç­–ç•¥

### 1. æ•°æ®åº“å¤‡ä»½
```bash
# å¤‡ä»½æ•°æ®åº“
mysqldump -u photo_user -p photo_gallery > backup_$(date +%Y%m%d).sql

# æ¢å¤æ•°æ®åº“
mysql -u photo_user -p photo_gallery < backup_20240101.sql
```

### 2. ç…§ç‰‡å¤‡ä»½
```bash
# å¤‡ä»½uploadsç›®å½•
tar -czf photos_backup_$(date +%Y%m%d).tar.gz /var/www/html/uploads/
```

### 3. é…ç½®æ–‡ä»¶å¤‡ä»½
```bash
# å¤‡ä»½Nginxé…ç½®
tar -czf nginx_config_backup.tar.gz /etc/nginx/

# å¤‡ä»½Node.jsæœåŠ¡
tar -czf esp32_office_backup.tar.gz /opt/esp32-receiver/
tar -czf pcroom_receiver_backup.tar.gz /opt/pcroom-receiver/

# å¤‡ä»½Mosquittoé…ç½®
tar -czf mosquitto_config_backup.tar.gz /etc/mosquitto/
```

### 4. è‡ªåŠ¨å¤‡ä»½è„šæœ¬ (å¯é€‰)
åˆ›å»º `/opt/backup/backup.sh`:
```bash
#!/bin/bash
BACKUP_DIR="/opt/backup"
DATE=$(date +%Y%m%d)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
mysqldump -u photo_user -p'PhotoSecurePass123!' photo_gallery > $BACKUP_DIR/photo_gallery_$DATE.sql

# å¤‡ä»½ç…§ç‰‡
tar -czf $BACKUP_DIR/photos_$DATE.tar.gz /var/www/html/uploads/

# å¤‡ä»½é…ç½®æ–‡ä»¶
tar -czf $BACKUP_DIR/config_$DATE.tar.gz /etc/nginx/ /etc/mosquitto/ /opt/esp32-receiver/ /opt/pcroom-receiver/

# åˆ é™¤30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "Backup completed: $DATE"
```

è®¾ç½®å®šæ—¶ä»»åŠ¡ (æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½):
```bash
crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œ
0 2 * * * /opt/backup/backup.sh >> /var/log/backup.log 2>&1
```

---

## ğŸ“ è”ç³»ä¿¡æ¯

- æœåŠ¡å™¨IP: 175.178.158.54
- SSHç«¯å£: 22
- ç®¡ç†ç”¨æˆ·: ubuntu

---

## ğŸ“„ ç‰ˆæœ¬å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| 2026-02-12 | v2.0 | æ·»åŠ PCæˆ¿é—´ESP32æœåŠ¡ï¼›ä¼˜åŒ–ä¸Šä¼ é—´éš”(60ç§’)ï¼›æ·»åŠ å®šæ—¶ç©ºè°ƒåŠŸèƒ½ï¼›æ›´æ–°æ¶æ„æ–‡æ¡£ |
| 2025-02-05 | v1.2 | æ·»åŠ MQTTæœåŠ¡æ”¯æŒç©ºè°ƒè¿œç¨‹æ§åˆ¶ï¼›æ›´æ–°ESP32åŠŸèƒ½è¯´æ˜ |
| 2024-01-29 | v1.0 | åˆå§‹æ¶æ„æ–‡æ¡£ |

---

## ğŸ“Œ é…ç½®æ–‡ä»¶æ¸…å•

### Nginxé…ç½®æ–‡ä»¶
- `/etc/nginx/nginx.conf` - ä¸»é…ç½®æ–‡ä»¶
- `/etc/nginx/sites-available/default` - é»˜è®¤ç«™ç‚¹é…ç½®
- `/etc/nginx/sites-available/esp32` - ç¾¤æ™–ESP32ä»£ç†é…ç½®
- `/etc/nginx/sites-available/esp32-office` - åŠå…¬å®¤ESP32é…ç½®
- `/etc/nginx/sites-available/pcroom-receiver` - PCæˆ¿é—´ESP32é…ç½®
- `/etc/nginx/sites-enabled/` - å¯ç”¨çš„ç«™ç‚¹ç¬¦å·é“¾æ¥

### Mosquittoé…ç½®æ–‡ä»¶
- `/etc/mosquitto/mosquitto.conf` - ä¸»é…ç½®æ–‡ä»¶
- `/etc/mosquitto/conf.d/custom.conf` - è‡ªå®šä¹‰é…ç½® (ç›‘å¬1883, å…è®¸åŒ¿å)

### PHP-FPMé…ç½®æ–‡ä»¶
- `/etc/php/8.3/fpm/php.ini` - PHPé…ç½®
- `/etc/php/8.3/fpm/pool.d/www.conf` - è¿›ç¨‹æ± é…ç½®

### MySQLé…ç½®æ–‡ä»¶
- `/etc/mysql/my.cnf` - ä¸»é…ç½®æ–‡ä»¶
- `/etc/mysql/mysql.conf.d/mysqld.cnf` - MySQLæœåŠ¡é…ç½®

### SystemdæœåŠ¡æ–‡ä»¶
- `/etc/systemd/system/esp32-office.service` - åŠå…¬å®¤æ¸©åº¦ç›‘æ§æœåŠ¡
- `/etc/systemd/system/pcroom-receiver.service` - PCæˆ¿é—´æ¸©åº¦ç›‘æ§æœåŠ¡
- `/lib/systemd/system/mosquitto.service` - MQTT BrokeræœåŠ¡ (é»˜è®¤)

### Node.jsæœåŠ¡ç›®å½•
- `/opt/esp32-receiver/server.js` - åŠå…¬å®¤Node.jsæœåŠ¡
- `/opt/pcroom-receiver/server.js` - PCæˆ¿é—´Node.jsæœåŠ¡

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- `ä½¿ç”¨è¯´æ˜.md` - ESP32é¡¹ç›®ä½¿ç”¨è¯´æ˜
- `main.cpp` - ESP32ä¸»ç¨‹åºæºä»£ç 
- `platformio.ini` - PlatformIOé¡¹ç›®é…ç½®
- `server_esp32_office_v2.js` - åŠå…¬å®¤Node.jsæœåŠ¡æºä»£ç 

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-12
