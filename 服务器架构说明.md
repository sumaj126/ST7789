# è…¾è®¯äº‘æœåŠ¡å™¨æ¶æ„æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†éƒ¨ç½²åœ¨è…¾è®¯äº‘æœåŠ¡å™¨ (175.178.158.54) ä¸Šçš„WebæœåŠ¡æ¶æ„ï¼Œä¸»è¦ç”¨äºå®¶åº­/åŠå…¬å®¤ç›‘æ§å’Œç…§ç‰‡ç®¡ç†ç³»ç»Ÿã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è…¾è®¯äº‘æœåŠ¡å™¨                          â”‚
â”‚                      175.178.158.54                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                     â”‚                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      ç«¯å£ 80 (HTTP)     â”‚              â”‚     ç«¯å£ 22 (SSH)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       Nginx (åå‘ä»£ç†)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚                â”‚
    â”‚                â”‚                â”‚
â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”
â”‚ 7788ç«¯å£ â”‚    â”‚ 7789ç«¯å£ â”‚   â”‚ æ ¹è·¯å¾„   â”‚
â”‚(ä¹¦æˆ¿æ¸©åº¦)â”‚    â”‚(åŠå…¬å®¤æ¸©åº¦)â”‚   â”‚ (ç…§ç‰‡ç«™) â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚               â”‚
    â”‚               â”‚               â”‚
å¤–éƒ¨ä»£ç†       å†…éƒ¨Node.js      PHP-FPM
               ç«¯å£3789        ç«¯å£9000
```

---

## ğŸ“¦ æœåŠ¡æ¸…å•

### 1. Nginx WebæœåŠ¡å™¨
**ç«¯å£**: 80, 7788, 7789

**åŠŸèƒ½**:
- åå‘ä»£ç†
- é™æ€æ–‡ä»¶æœåŠ¡
- SSLæ”¯æŒ
- è´Ÿè½½å‡è¡¡

**é…ç½®æ–‡ä»¶ä½ç½®**:
- ä¸»é…ç½®: `/etc/nginx/nginx.conf`
- ç«™ç‚¹é…ç½®: `/etc/nginx/sites-available/`
- å¯ç”¨ç«™ç‚¹: `/etc/nginx/sites-enabled/`

### 2. PHP-FPM (PHP FastCGI Process Manager)
**ç«¯å£**: 9000 (Unix Socket: `/var/run/php/php8.3-fpm.sock`)

**åŠŸèƒ½**:
- å¤„ç†PHPè¯·æ±‚
- ç…§ç‰‡ä¸Šä¼ API
- æ•°æ®åº“æ“ä½œ

**é…ç½®æ–‡ä»¶**: `/etc/php/8.3/fpm/`

### 3. MySQL æ•°æ®åº“
**ç«¯å£**: 3306

**æ•°æ®åº“**: `photo_gallery`

**åŠŸèƒ½**:
- å­˜å‚¨ç…§ç‰‡å…ƒæ•°æ®
- ç®¡ç†ç›¸å†Œç›®å½•
- ç”¨æˆ·è®¤è¯ä¿¡æ¯

**é…ç½®æ–‡ä»¶**: `/etc/mysql/my.cnf`

### 4. Node.js åŠå…¬å®¤æ¸©åº¦ç›‘æ§æœåŠ¡
**ç«¯å£**: 3789 (å†…éƒ¨)

**åŠŸèƒ½**:
- æ¥æ”¶ESP32ä¸Šä¼ çš„æ¸©æ¹¿åº¦æ•°æ®
- æä¾›Webç›‘æ§é¡µé¢
- æ•°æ®å®æ—¶æ˜¾ç¤º

**æœåŠ¡ä¿¡æ¯**:
- å·¥ä½œç›®å½•: `/opt/esp32-receiver/`
- ä¸»ç¨‹åº: `server.js`
- SystemdæœåŠ¡: `esp32-office.service`

---

## ğŸŒ æœåŠ¡ç«¯ç‚¹è¯¦è§£

### ğŸ“ ç«¯å£ 80 - ä¸»ç½‘ç«™ (ç…§ç‰‡ç®¡ç†ç³»ç»Ÿ)

#### è·¯ç”±é…ç½®

| è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ | å¤„ç†æ–¹å¼ |
|------|------|------|---------|
| `/` | GET | ç…§ç‰‡å±•ç¤ºä¸»é¡µ | index.html |
| `/login` | GET | ç™»å½•é¡µé¢ | login.html |
| `/api/albums` | GET | è·å–ç›¸å†Œåˆ—è¡¨ | api.php |
| `/api/albums` | POST | åˆ›å»ºç›¸å†Œ | api.php |
| `/api/albums/{id}` | PUT | ç¼–è¾‘ç›¸å†Œ | api.php |
| `/api/albums/{id}` | DELETE | åˆ é™¤ç›¸å†Œ | api.php |
| `/api/photos` | GET | è·å–ç…§ç‰‡åˆ—è¡¨ | api.php |
| `/api/upload` | POST | ä¸Šä¼ ç…§ç‰‡ | api.php |
| `/api/photos/{id}` | DELETE | åˆ é™¤ç…§ç‰‡ | api.php |
| `/uploads/*` | GET | ç…§ç‰‡æ–‡ä»¶ | é™æ€æ–‡ä»¶ |

#### æ–‡ä»¶ç»“æ„
```
/var/www/html/
â”œâ”€â”€ index.html          # ä¸»é¡µé¢
â”œâ”€â”€ login.html          # ç™»å½•é¡µé¢
â”œâ”€â”€ api.php            # APIå¤„ç†è„šæœ¬
â”œâ”€â”€ uploads/           # ç…§ç‰‡å­˜å‚¨ç›®å½•
â””â”€â”€ .htaccess          # Apacheå…¼å®¹é…ç½®
```

#### æ•°æ®åº“è¡¨ç»“æ„

**albums è¡¨**
```sql
CREATE TABLE albums (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) NOT NULL
);
```

**photos è¡¨**
```sql
CREATE TABLE photos (
  id INT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(255),
  date DATE,
  image_url VARCHAR(255),
  album_id INT,
  created_at DATETIME,
  FOREIGN KEY (album_id) REFERENCES albums(id)
);
```

#### è®¤è¯æ–¹å¼
- localStorage token: `auth_token`
- ç®€å•è®¤è¯æœºåˆ¶

---

### ğŸ“ ç«¯å£ 7788 - ä¹¦æˆ¿æ¸©åº¦ç›‘æ§ (å¤–éƒ¨ä»£ç†)

#### åå‘ä»£ç†é…ç½®
```nginx
server {
    listen 7788;
    server_name _;
    
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'Content-Type';
    
    location / {
        proxy_pass http://sumaj.synology.me:7788;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 10s;
        proxy_read_timeout 10s;
        proxy_send_timeout 10s;
    }
}
```

**è¯´æ˜**: æ­¤ç«¯å£ä»£ç†åˆ°å¤–éƒ¨çš„Synology NASè®¾å¤‡

---

### ğŸ“ ç«¯å£ 7789 - åŠå…¬å®¤æ¸©åº¦ç›‘æ§

#### æ¶æ„
```
å¤–éƒ¨è®¿é—® (7789)
    â†“
Nginx åå‘ä»£ç†
    â†“
Node.js æœåŠ¡ (3789)
```

#### Nginxé…ç½®
```nginx
server {
    listen 7789;
    server_name _;
    
    add_header 'Access-Control-Allow-Origin' '*';
    
    location / {
        proxy_pass http://127.0.0.1:3789;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### Node.jsæœåŠ¡ (`/opt/esp32-receiver/server.js`)

**æ¥æ”¶æ•°æ®æ¥å£**:
- URL: `http://175.178.158.54:7789/update`
- æ–¹æ³•: POST
- Content-Type: application/json
- æ•°æ®æ ¼å¼:
  ```json
  {
    "temperature": 26.5,
    "humidity": 65.0
  }
  ```

**ç›‘æ§é¡µé¢**:
- URL: `http://175.178.158.54:7789/`
- æ–¹æ³•: GET
- åŠŸèƒ½: æ˜¾ç¤ºå®æ—¶æ¸©æ¹¿åº¦æ•°æ®
- è‡ªåŠ¨åˆ·æ–°: 10ç§’

#### SystemdæœåŠ¡é…ç½®
```ini
[Unit]
Description=ESP32 Office Monitor
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/esp32-receiver
ExecStart=/usr/bin/node /opt/esp32-receiver/server.js
Restart=always
User=ubuntu

[Install]
WantedBy=multi-user.target
```

#### æœåŠ¡ç®¡ç†å‘½ä»¤
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start esp32-office

# åœæ­¢æœåŠ¡
sudo systemctl stop esp32-office

# é‡å¯æœåŠ¡
sudo systemctl restart esp32-office

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status esp32-office

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u esp32-office -f

# å¼€æœºè‡ªå¯
sudo systemctl enable esp32-office
```

---

## ğŸ”„ æ•°æ®æµç¨‹

### æ¸©æ¹¿åº¦æ•°æ®ä¸Šä¼ æµç¨‹

```
ESP32 è®¾å¤‡
  â†“ (WiFi)
  â†“ POST {"temperature": 26.5, "humidity": 65.0}
  â†“
Nginx (ç«¯å£7789)
  â†“ åå‘ä»£ç†
  â†“
Node.js (ç«¯å£3789)
  â†“ è§£æJSON
  â†“ å­˜å‚¨åˆ°å†…å­˜å˜é‡
  â†“
Webé¡µé¢ (GET /)
  â†“ è¿”å›HTML
  â†“ æ˜¾ç¤ºæ•°æ®
  â†“ 10ç§’è‡ªåŠ¨åˆ·æ–°
```

### ç…§ç‰‡ä¸Šä¼ æµç¨‹

```
ç”¨æˆ·æµè§ˆå™¨
  â†“ ç™»å½•éªŒè¯
  â†“ é€‰æ‹©ç…§ç‰‡
  â†“
Nginx (ç«¯å£80)
  â†“ è½¬å‘åˆ°PHP
  â†“
PHP-FPM (api.php)
  â†“ éªŒè¯æ–‡ä»¶
  â†“ ä¿å­˜åˆ° /var/www/html/uploads/
  â†“ æå–EXIFä¿¡æ¯
  â†“ å­˜å‚¨åˆ°MySQL
  â†“
è¿”å›æˆåŠŸå“åº”
```

---

## ğŸ”§ ç³»ç»ŸæœåŠ¡ç®¡ç†

### Nginx
```bash
# å¯åŠ¨/åœæ­¢/é‡å¯
sudo systemctl start nginx
sudo systemctl stop nginx
sudo systemctl restart nginx

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½é…ç½®
sudo nginx -s reload
```

### PHP-FPM
```bash
sudo systemctl start php8.3-fpm
sudo systemctl stop php8.3-fpm
sudo systemctl restart php8.3-fpm
```

### MySQL
```bash
sudo systemctl start mysql
sudo systemctl stop mysql
sudo systemctl restart mysql
```

---

## ğŸ” å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™ (UFW)
```bash
# æŸ¥çœ‹çŠ¶æ€
sudo ufw status

# å…è®¸ç«¯å£
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS
sudo ufw allow 7788/tcp # ä¹¦æˆ¿æ¸©åº¦
sudo ufw allow 7789/tcp # åŠå…¬å®¤æ¸©åº¦
```

### 2. æ•°æ®åº“å®‰å…¨
- æ•°æ®åº“ç”¨æˆ·: `photo_user`
- æ•°æ®åº“å¯†ç : `PhotoSecurePass123!`
- ä»…å…è®¸æœ¬åœ°è¿æ¥: `localhost`

### 3. æ–‡ä»¶æƒé™
```bash
/var/www/html/ - 755 (ubuntu:ubuntu)
/var/www/html/uploads/ - 755 (www-data:www-data)
/opt/esp32-receiver/ - 755 (root:root)
```

---

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—æ–‡ä»¶ä½ç½®

| æœåŠ¡ | æ—¥å¿—è·¯å¾„ | è¯´æ˜ |
|------|---------|------|
| Nginx | `/var/log/nginx/access.log` | è®¿é—®æ—¥å¿— |
| Nginx | `/var/log/nginx/error.log` | é”™è¯¯æ—¥å¿— |
| PHP-FPM | `/var/log/php8.3-fpm.log` | PHPæ—¥å¿— |
| MySQL | `/var/log/mysql/error.log` | MySQLæ—¥å¿— |
| Node.js | `journalctl -u esp32-office` | æ¸©åº¦ç›‘æ§æ—¥å¿— |

### æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
# Nginxè®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log

# Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# Node.jsæœåŠ¡æ—¥å¿—
sudo journalctl -u esp32-office -f
```

---

## ğŸš€ éƒ¨ç½²ESP32è®¾å¤‡

### ESP32ä»£ç é…ç½®

**WiFié…ç½®**:
```cpp
const char* ssid = "æ‚¨çš„WiFiåç§°";
const char* password = "æ‚¨çš„WiFiå¯†ç ";
```

**æœåŠ¡å™¨é…ç½®**:
```cpp
const char* serverUrl = "http://175.178.158.54:7789/update";
const unsigned long uploadInterval = 5000;  // 5ç§’ä¸Šä¼ ä¸€æ¬¡
```

**ä¸Šä¼ æ•°æ®æ ¼å¼**:
```json
{
  "temperature": 26.5,
  "humidity": 65.0
}
```

### ESP32ç¡¬ä»¶è¿æ¥

| ä¼ æ„Ÿå™¨ | å¼•è„š | è¯´æ˜ |
|--------|------|------|
| DHT22 VCC | 3.3V | ç”µæº |
| DHT22 GND | GND | åœ°çº¿ |
| DHT22 DATA | GPIO14 | æ•°æ® |

---

## ğŸ“± å‰ç«¯è®¿é—®

### ç…§ç‰‡ç®¡ç†ç³»ç»Ÿ
- URL: `http://175.178.158.54/`
- åŠŸèƒ½: ç…§ç‰‡æµè§ˆã€ä¸Šä¼ ã€ç›¸å†Œç®¡ç†

### ä¹¦æˆ¿æ¸©åº¦ç›‘æ§
- URL: `http://175.178.158.54:7788/`
- åŠŸèƒ½: å®æ—¶æ¸©æ¹¿åº¦æ˜¾ç¤º

### åŠå…¬å®¤æ¸©åº¦ç›‘æ§
- URL: `http://175.178.158.54:7789/`
- åŠŸèƒ½: å®æ—¶æ¸©æ¹¿åº¦æ˜¾ç¤º

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### 1. æ¸©åº¦ç›‘æ§é¡µé¢æ˜¾ç¤º"ç¦»çº¿"
**åŸå› **: ESP32æœªä¸Šä¼ æ•°æ®è¶…è¿‡30ç§’
**è§£å†³**:
- æ£€æŸ¥ESP32æ˜¯å¦æ­£å¸¸è¿è¡Œ
- æ£€æŸ¥WiFiè¿æ¥
- æ£€æŸ¥Node.jsæœåŠ¡çŠ¶æ€: `sudo systemctl status esp32-office`
- æŸ¥çœ‹æœåŠ¡æ—¥å¿—: `sudo journalctl -u esp32-office -n 50`

### 2. ç…§ç‰‡ä¸Šä¼ å¤±è´¥
**åŸå› **: PHP-FPMæœåŠ¡å¼‚å¸¸æˆ–ç£ç›˜ç©ºé—´ä¸è¶³
**è§£å†³**:
- æ£€æŸ¥PHP-FPM: `sudo systemctl status php8.3-fpm`
- æ£€æŸ¥ç£ç›˜ç©ºé—´: `df -h`
- æ£€æŸ¥uploadsç›®å½•æƒé™: `ls -la /var/www/html/uploads/`

### 3. Nginx 502é”™è¯¯
**åŸå› **: åç«¯æœåŠ¡æœªå¯åŠ¨
**è§£å†³**:
- æ£€æŸ¥PHP-FPM: `sudo systemctl status php8.3-fpm`
- æ£€æŸ¥Node.js: `sudo systemctl status esp32-office`
- æ£€æŸ¥Socketæ–‡ä»¶: `ls -la /var/run/php/`

### 4. ç«¯å£æ— æ³•è®¿é—®
**åŸå› **: é˜²ç«å¢™æˆ–Nginxé…ç½®é—®é¢˜
**è§£å†³**:
```bash
# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep -E "80|7788|7789"

# æµ‹è¯•Nginxé…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx
```

---

## ğŸ“ å¤‡ä»½ç­–ç•¥

### 1. æ•°æ®åº“å¤‡ä»½
```bash
# å¤‡ä»½æ•°æ®åº“
mysqldump -u photo_user -p photo_gallery > backup_$(date +%Y%m%d).sql

# æ¢å¤æ•°æ®åº“
mysql -u photo_user -p photo_gallery < backup_20240101.sql
```

### 2. ç…§ç‰‡å¤‡ä»½
```bash
# å¤‡ä»½uploadsç›®å½•
tar -czf photos_backup_$(date +%Y%m%d).tar.gz /var/www/html/uploads/
```

### 3. é…ç½®æ–‡ä»¶å¤‡ä»½
```bash
# å¤‡ä»½Nginxé…ç½®
tar -czf nginx_config_backup.tar.gz /etc/nginx/

# å¤‡ä»½Node.jsæœåŠ¡
tar -czf esp32_receiver_backup.tar.gz /opt/esp32-receiver/
```

---

## ğŸ“ è”ç³»ä¿¡æ¯

- æœåŠ¡å™¨IP: 175.178.158.54
- SSHç«¯å£: 22
- ç®¡ç†ç”¨æˆ·: ubuntu

---

## ğŸ“„ ç‰ˆæœ¬å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| 2024-01-29 | v1.0 | åˆå§‹æ¶æ„æ–‡æ¡£ |

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2024-01-29
